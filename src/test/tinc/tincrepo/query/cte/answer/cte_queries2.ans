-- @author prabhd 
-- @created 2012-02-01 12:00:00 
-- @modified 2013-02-01 12:00:00 
-- @tags cte HAWQ 
-- @product_version gpdb: [4.3-],hawq: [1.1-]
-- @db_name world_db
-- @description cte tests from cdbfast 

--queries with a single CTE used more than once in different parts of the main query
-- query1
-- Similar to genetech query 'dxAcctMonthlyTrending_Avastin_WITH_Clause.sql'
-- This kind of query is their only use case for CTE. We dont error, we give correct results,use shared scan here and we are good ! 
select count(*) from
( select r.* from
  ( with fact as 
     (
      select country.name as COUNTRY,country.code,city.name as CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,AGG1.region
      from      
         (select
         sum(case when (city.population >= 0.5 * country.population) then country.population else city.population end) as S_POPULATION,
         sum(case when (gnp >= gnpold) then gnp else gnpold end) as S_GNP,
         avg(case when (lifeexpectancy > 60) then 50 else lifeexpectancy end) as AVG_LIFE,country.region
         from country,city  
         where governmentform != 'Constitutional Monarchy'
         and country.capital = city.id
         and indepyear > 0
         group by country.region) AGG1
         ,country,city
         where country.capital = city.id
         and country.region = AGG1.region
      )
     
     select code,COUNTRY,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage
     where fact.code = countrylanguage.countrycode and isofficial = 'True'
     and fact.region = 'South America'
     
     UNION ALL
     
     select code,COUNTRY,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage
     where fact.code = countrylanguage.countrycode and isofficial = 'True'
     and fact.region = 'North America'
     
     UNION ALL
     
     select code,COUNTRY,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage
     where fact.code = countrylanguage.countrycode and isofficial = 'True'
     and fact.region = 'Caribbean'
 ) as r
 left join
  (
   select 'ARG' as CODE UNION ALL
   select 'BOL' as CODE UNION ALL
   select 'BRA' as CODE UNION ALL
   select 'PER' as CODE UNION ALL
   select 'URY' as CODE UNION ALL
   select 'IND' as CODE  UNION ALL
   select 'LCA' as CODE UNION ALL
   select 'VCT' as CODE
   ) as r1
on r.code = r1.code) AS FOO;
 count 
-------
    43
(1 row)

-- query2
with alleuropeanlanguages as 
(select country.code,country.name COUNTRY, city.name CAPITAL, language, isofficial, percentage
 FROM country,city,countrylanguage
 WHERE country.code = countrylanguage.countrycode
 and country.capital = city.id
 and country.continent = 'Europe')
select * from
(select * from alleuropeanlanguages where isofficial='True') e1,
(select * from alleuropeanlanguages where percentage > 50) e2
where e1.code = e2.code order by e2.COUNTRY,e1.language;
 code |        country         |              capital              |    language    | isofficial | percentage | code |        country         |              capital              |    language    | isofficial | percentage 
------+------------------------+-----------------------------------+----------------+------------+------------+------+------------------------+-----------------------------------+----------------+------------+------------
 ALB  | Albania                | Tirana                            | Albaniana      | t          |       97.9 | ALB  | Albania                | Tirana                            | Albaniana      | t          |       97.9
 AUT  | Austria                | Wien                              | German         | t          |         92 | AUT  | Austria                | Wien                              | German         | t          |         92
 BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6 | BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6
 BLR  | Belarus                | Minsk                             | Russian        | t          |         32 | BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6
 BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BEL  | Belgium                | Bruxelles [Brussel]               | French         | t          |       32.6 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BEL  | Belgium                | Bruxelles [Brussel]               | German         | t          |          1 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BIH  | Bosnia and Herzegovina | Sarajevo                          | Serbo-Croatian | t          |       99.2 | BIH  | Bosnia and Herzegovina | Sarajevo                          | Serbo-Croatian | t          |       99.2
 BGR  | Bulgaria               | Sofija                            | Bulgariana     | t          |       83.2 | BGR  | Bulgaria               | Sofija                            | Bulgariana     | t          |       83.2
 HRV  | Croatia                | Zagreb                            | Serbo-Croatian | t          |       95.9 | HRV  | Croatia                | Zagreb                            | Serbo-Croatian | t          |       95.9
 CZE  | Czech Republic         | Praha                             | Czech          | t          |       81.2 | CZE  | Czech Republic         | Praha                             | Czech          | t          |       81.2
 DNK  | Denmark                | Kobenhavn                         | Danish         | t          |       93.5 | DNK  | Denmark                | Kobenhavn                         | Danish         | t          |       93.5
 EST  | Estonia                | Tallinn                           | Estonian       | t          |       65.3 | EST  | Estonia                | Tallinn                           | Estonian       | t          |       65.3
 FRO  | Faroe Islands          | Torshavn                          | Danish         | t          |          0 | FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100
 FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100 | FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100
 FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7 | FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7
 FIN  | Finland                | Helsinki [Helsingfors]            | Swedish        | t          |        5.7 | FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7
 FRA  | France                 | Paris                             | French         | t          |       93.6 | FRA  | France                 | Paris                             | French         | t          |       93.6
 DEU  | Germany                | Berlin                            | German         | t          |       91.3 | DEU  | Germany                | Berlin                            | German         | t          |       91.3
 GIB  | Gibraltar              | Gibraltar                         | English        | t          |       88.9 | GIB  | Gibraltar              | Gibraltar                         | English        | t          |       88.9
 GRC  | Greece                 | Athenai                           | Greek          | t          |       98.5 | GRC  | Greece                 | Athenai                           | Greek          | t          |       98.5
 HUN  | Hungary                | Budapest                          | Hungarian      | t          |       98.5 | HUN  | Hungary                | Budapest                          | Hungarian      | t          |       98.5
 ISL  | Iceland                | Reykjavik                         | Icelandic      | t          |       95.7 | ISL  | Iceland                | Reykjavik                         | Icelandic      | t          |       95.7
 IRL  | Ireland                | Dublin                            | English        | t          |       98.4 | IRL  | Ireland                | Dublin                            | English        | t          |       98.4
 IRL  | Ireland                | Dublin                            | Irish          | t          |        1.6 | IRL  | Ireland                | Dublin                            | English        | t          |       98.4
 ITA  | Italy                  | Roma                              | Italian        | t          |       94.1 | ITA  | Italy                  | Roma                              | Italian        | t          |       94.1
 LVA  | Latvia                 | Riga                              | Latvian        | t          |       55.1 | LVA  | Latvia                 | Riga                              | Latvian        | t          |       55.1
 LIE  | Liechtenstein          | Vaduz                             | German         | t          |         89 | LIE  | Liechtenstein          | Vaduz                             | German         | t          |         89
 LTU  | Lithuania              | Vilnius                           | Lithuanian     | t          |       81.6 | LTU  | Lithuania              | Vilnius                           | Lithuanian     | t          |       81.6
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | French         | t          |        4.2 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | German         | t          |        2.3 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 MKD  | Macedonia              | Skopje                            | Macedonian     | t          |       66.5 | MKD  | Macedonia              | Skopje                            | Macedonian     | t          |       66.5
 MLT  | Malta                  | Valletta                          | English        | t          |        2.1 | MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8
 MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8 | MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8
 MDA  | Moldova                | Chisinau                          | Romanian       | t          |       61.9 | MDA  | Moldova                | Chisinau                          | Romanian       | t          |       61.9
 NLD  | Netherlands            | Amsterdam                         | Dutch          | t          |       95.6 | NLD  | Netherlands            | Amsterdam                         | Dutch          | t          |       95.6
 NOR  | Norway                 | Oslo                              | Norwegian      | t          |       96.6 | NOR  | Norway                 | Oslo                              | Norwegian      | t          |       96.6
 POL  | Poland                 | Warszawa                          | Polish         | t          |       97.6 | POL  | Poland                 | Warszawa                          | Polish         | t          |       97.6
 PRT  | Portugal               | Lisboa                            | Portuguese     | t          |         99 | PRT  | Portugal               | Lisboa                            | Portuguese     | t          |         99
 ROM  | Romania                | Bucuresti                         | Romani         | t          |        0.7 | ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7
 ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7 | ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7
 RUS  | Russian Federation     | Moscow                            | Russian        | t          |       86.6 | RUS  | Russian Federation     | Moscow                            | Russian        | t          |       86.6
 SMR  | San Marino             | San Marino                        | Italian        | t          |        100 | SMR  | San Marino             | San Marino                        | Italian        | t          |        100
 SVK  | Slovakia               | Bratislava                        | Slovak         | t          |       85.6 | SVK  | Slovakia               | Bratislava                        | Slovak         | t          |       85.6
 SVN  | Slovenia               | Ljubljana                         | Slovene        | t          |       87.9 | SVN  | Slovenia               | Ljubljana                         | Slovene        | t          |       87.9
 ESP  | Spain                  | Madrid                            | Spanish        | t          |       74.4 | ESP  | Spain                  | Madrid                            | Spanish        | t          |       74.4
 SWE  | Sweden                 | Stockholm                         | Swedish        | t          |       89.5 | SWE  | Sweden                 | Stockholm                         | Swedish        | t          |       89.5
 CHE  | Switzerland            | Bern                              | French         | t          |       19.2 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | German         | t          |       63.6 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | Italian        | t          |        7.7 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | Romansh        | t          |        0.6 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 UKR  | Ukraine                | Kyiv                              | Ukrainian      | t          |       64.7 | UKR  | Ukraine                | Kyiv                              | Ukrainian      | t          |       64.7
 GBR  | United Kingdom         | London                            | English        | t          |       97.3 | GBR  | United Kingdom         | London                            | English        | t          |       97.3
 YUG  | Yugoslavia             | Beograd                           | Serbo-Croatian | t          |       75.2 | YUG  | Yugoslavia             | Beograd                           | Serbo-Croatian | t          |       75.2
(55 rows)

-- query3
with allcountrystats as 
( select country.code,country.name,count(distinct city.id) CITY_CNT,
  count(distinct countrylanguage.language) LANG_CNT
  from country,city,countrylanguage
  where country.code = city.countrycode
  and country.code = countrylanguage.countrycode
  group by country.code,country.name
)
select sum(FOO.CITY_CNT) REGION_CITY_CNT,sum(FOO.LANG_CNT) REGION_LANG_CNT,FOO.region
FROM
(
select allcountrystats.code,allcountrystats.name COUNTRY,CITY_CNT,LANG_CNT,country.region,city.name CAPITAL
from allcountrystats,country,city
where allcountrystats.code = country.code
and country.capital = city.id
and CITY_CNT/LANG_CNT > 1
and country.continent = 'Asia'
UNION ALL
select allcountrystats.code,allcountrystats.name COUNTRY,CITY_CNT,LANG_CNT,country.region,city.name CAPITAL
from allcountrystats,country,city
where allcountrystats.code = country.code
and country.capital = city.id
and CITY_CNT/LANG_CNT > 1
and country.continent = 'North America'
UNION ALL
select allcountrystats.code,allcountrystats.name COUNTRY,CITY_CNT,LANG_CNT,country.region,city.name CAPITAL
from allcountrystats,country,city
where allcountrystats.code = country.code
and country.capital = city.id
and CITY_CNT/LANG_CNT > (select  max(CITY_CNT/LANG_CNT)  from allcountrystats,country where allcountrystats.code = country.code AND country.continent='Europe')
) FOO
,allcountrystats,country
WHERE allcountrystats.code = country.code
and FOO.region = country.region
group by FOO.region order by FOO.region;
 region_city_cnt | region_lang_cnt |          region           
-----------------+-----------------+---------------------------
             840 |             192 | Caribbean
            2824 |             112 | Central America
           11336 |             384 | Eastern Asia
            2664 |             396 | Middle East
            1625 |             125 | North America
            3500 |              70 | South America
            3179 |             528 | Southeast Asia
           12278 |             896 | Southern and Central Asia
(8 rows)

--query 4
with diversecountries as
(select country.code,country.name,country.capital,d.CNT
 from country,
 (select countrylanguage.countrycode,count(*) as CNT from countrylanguage group by countrycode
  HAVING count(*) > 6) d
 where d.countrycode = country.code and country.gnp > 100000)
select d1.code,d1.name,d1.capital,city.name CAPITAL_CITY,d1.CNT,d2.CNT
from
diversecountries d1 left join country
ON (d1.code = country.code AND d1.CNT < 8)
left join diversecountries d2
ON (country.code = d2.code AND d2.CNT > 8)
INNER JOIN city
ON(d1.capital = city.id)
ORDER BY d1.name;
 code |        name        | capital |   capital_city   | cnt | cnt 
------+--------------------+---------+------------------+-----+-----
 AUS  | Australia          |     135 | Canberra         |   8 |    
 AUT  | Austria            |    1523 | Wien             |   8 |    
 CAN  | Canada             |    1822 | Ottawa           |  12 |    
 CHN  | China              |    1891 | Peking           |  12 |    
 DNK  | Denmark            |    3315 | Kobenhavn        |   7 |    
 IND  | India              |    1109 | New Delhi        |  12 |    
 IRN  | Iran               |    1380 | Teheran          |  10 |    
 ITA  | Italy              |    1464 | Roma             |   8 |    
 MMR  | Myanmar            |    2710 | Rangoon (Yangon) |   8 |    
 RUS  | Russian Federation |    3580 | Moscow           |  12 |    
 ZAF  | South Africa       |     716 | Pretoria         |  11 |    
 USA  | United States      |    3813 | Washington       |  12 |    
(12 rows)

--query 5 Use CTE more than once in select list , from clause and where clause without correlation
with official_languages as
(
 select country.code,country.name,countrylanguage.language
 from
 country,countrylanguage
 where country.code = countrylanguage.countrycode and isofficial = 'True'
 and country.governmentform NOT  IN (select 'Commonwealth of the US' UNION ALL select 'Monarchy (Sultanate)' UNION ALL select 'Monarchy')
 and country.gnp > (select min(gnpold) from country where country.region = 'Western Europe')
)
select 
( select max(CNT) from (select count(*) CNT,o1.name from official_languages o1, official_languages o2
  where o1.code = o2.code group by o1.name) FOO
),* from official_languages;
 ?column? | code |          name          |     language     
----------+------+------------------------+------------------
       16 | AFG  | Afghanistan            | Pashto
       16 | NLD  | Netherlands            | Dutch
       16 | ANT  | Netherlands Antilles   | Papiamento
       16 | ALB  | Albania                | Albaniana
       16 | DZA  | Algeria                | Arabic
       16 | ARE  | United Arab Emirates   | Arabic
       16 | ARG  | Argentina              | Spanish
       16 | ARM  | Armenia                | Armenian
       16 | AUS  | Australia              | English
       16 | AZE  | Azerbaijan             | Azerbaijani
       16 | BHR  | Bahrain                | Arabic
       16 | BGD  | Bangladesh             | Bengali
       16 | BEL  | Belgium                | Dutch
       16 | BMU  | Bermuda                | English
       16 | BOL  | Bolivia                | Spanish
       16 | BIH  | Bosnia and Herzegovina | Serbo-Croatian
       16 | BRA  | Brazil                 | Portuguese
       16 | GBR  | United Kingdom         | English
       16 | BGR  | Bulgaria               | Bulgariana
       16 | CYM  | Cayman Islands         | English
       16 | CHL  | Chile                  | Spanish
       16 | CRI  | Costa Rica             | Spanish
       16 | DOM  | Dominican Republic     | Spanish
       16 | ECU  | Ecuador                | Spanish
       16 | EGY  | Egypt                  | Arabic
       16 | SLV  | El Salvador            | Spanish
       16 | ESP  | Spain                  | Spanish
       16 | ZAF  | South Africa           | Zulu
       16 | FJI  | Fiji Islands           | Fijian
       16 | PHL  | Philippines            | Pilipino
       16 | GEO  | Georgia                | Georgiana
       16 | GUM  | Guam                   | English
       16 | GTM  | Guatemala              | Spanish
       16 | HND  | Honduras               | Spanish
       16 | IND  | India                  | Hindi
       16 | IRQ  | Iraq                   | Arabic
       16 | IRN  | Iran                   | Persian
       16 | IRL  | Ireland                | English
       16 | ISL  | Iceland                | Icelandic
       16 | ISR  | Israel                 | Hebrew
       16 | ITA  | Italy                  | Italian
       16 | AUT  | Austria                | German
       16 | JPN  | Japan                  | Japanese
       16 | YEM  | Yemen                  | Arabic
       16 | JOR  | Jordan                 | Arabic
       16 | YUG  | Yugoslavia             | Serbo-Croatian
       16 | KHM  | Cambodia               | Khmer
       16 | CAN  | Canada                 | English
       16 | KAZ  | Kazakstan              | Kazakh
       16 | CHN  | China                  | Chinese
       16 | KGZ  | Kyrgyzstan             | Kirgiz
       16 | COL  | Colombia               | Spanish
       16 | COM  | Comoros                | Comorian
       16 | PRK  | North Korea            | Korean
       16 | KOR  | South Korea            | Korean
       16 | GRC  | Greece                 | Greek
       16 | HRV  | Croatia                | Serbo-Croatian
       16 | CUB  | Cuba                   | Spanish
       16 | KWT  | Kuwait                 | Arabic
       16 | CYP  | Cyprus                 | Greek
       16 | LAO  | Laos                   | Lao
       16 | LVA  | Latvia                 | Latvian
       16 | LBN  | Lebanon                | Arabic
       16 | LBY  | Libyan Arab Jamahiriya | Arabic
       16 | LIE  | Liechtenstein          | German
       16 | LTU  | Lithuania              | Lithuanian
       16 | LUX  | Luxembourg             | Luxembourgish
       16 | MDG  | Madagascar             | Malagasy
       16 | MKD  | Macedonia              | Macedonian
       16 | MWI  | Malawi                 | Chichewa
       16 | MYS  | Malaysia               | Malay
       16 | MLT  | Malta                  | Maltese
       16 | MAR  | Morocco                | Arabic
       16 | MEX  | Mexico                 | Spanish
       16 | MDA  | Moldova                | Romanian
       16 | MMR  | Myanmar                | Burmese
       16 | NPL  | Nepal                  | Nepali
       16 | NIC  | Nicaragua              | Spanish
       16 | NOR  | Norway                 | Norwegian
       16 | PAN  | Panama                 | Spanish
       16 | PRY  | Paraguay               | Spanish
       16 | PER  | Peru                   | Spanish
       16 | PRT  | Portugal               | Portuguese
       16 | POL  | Poland                 | Polish
       16 | FRA  | France                 | French
       16 | ROM  | Romania                | Romanian
       16 | RWA  | Rwanda                 | Rwanda
       16 | SWE  | Sweden                 | Swedish
       16 | DEU  | Germany                | German
       16 | SEN  | Senegal                | Wolof
       16 | SGP  | Singapore              | Chinese
       16 | SVK  | Slovakia               | Slovak
       16 | SVN  | Slovenia               | Slovene
       16 | LKA  | Sri Lanka              | Singali
       16 | SDN  | Sudan                  | Arabic
       16 | FIN  | Finland                | Finnish
       16 | CHE  | Switzerland            | German
       16 | SYR  | Syria                  | Arabic
       16 | TJK  | Tajikistan             | Tadzhik
       16 | DNK  | Denmark                | Danish
       16 | THA  | Thailand               | Thai
       16 | TGO  | Togo                   | Ewe
       16 | CZE  | Czech Republic         | Czech
       16 | TUN  | Tunisia                | Arabic
       16 | TUR  | Turkey                 | Turkish
       16 | TKM  | Turkmenistan           | Turkmenian
       16 | UKR  | Ukraine                | Ukrainian
       16 | HUN  | Hungary                | Hungarian
       16 | URY  | Uruguay                | Spanish
       16 | NZL  | New Zealand            | English
       16 | UZB  | Uzbekistan             | Uzbek
       16 | BLR  | Belarus                | Belorussian
       16 | VEN  | Venezuela              | Spanish
       16 | RUS  | Russian Federation     | Russian
       16 | VNM  | Vietnam                | Vietnamese
       16 | EST  | Estonia                | Estonian
       16 | USA  | United States          | English
       16 | AFG  | Afghanistan            | Dari
       16 | AND  | Andorra                | Catalan
       16 | BRB  | Barbados               | English
       16 | BEL  | Belgium                | French
       16 | BOL  | Bolivia                | Ketdua
       16 | ZAF  | South Africa           | Xhosa
       16 | GLP  | Guadeloupe             | French
       16 | GUM  | Guam                   | Chamorro
       16 | HTI  | Haiti                  | French
       16 | HKG  | Hong Kong              | English
       16 | IRL  | Ireland                | Irish
       16 | ISR  | Israel                 | Arabic
       16 | CAN  | Canada                 | French
       16 | KGZ  | Kyrgyzstan             | Russian
       16 | CYP  | Cyprus                 | Turkish
       16 | MAC  | Macao                  | Portuguese
       16 | MDG  | Madagascar             | French
       16 | MLT  | Malta                  | English
       16 | MTQ  | Martinique             | French
       16 | PRY  | Paraguay               | Guarani
       16 | PER  | Peru                   | Ketdua
       16 | RWA  | Rwanda                 | French
       16 | SGP  | Singapore              | Malay
       16 | LKA  | Sri Lanka              | Tamil
       16 | FIN  | Finland                | Swedish
       16 | CHE  | Switzerland            | French
       16 | TWN  | Taiwan                 | Mandarin Chinese
       16 | TZA  | Tanzania               | Swahili
       16 | TGO  | Togo                   | Kabye
       16 | TCD  | Chad                   | Arabic
       16 | NCL  | New Caledonia          | French
       16 | BLR  | Belarus                | Russian
       16 | ANT  | Netherlands Antilles   | Dutch
       16 | BOL  | Bolivia                | Aimara
       16 | ZAF  | South Africa           | Afrikaans
       16 | IDN  | Indonesia              | Malay
       16 | PER  | Peru                   | Aimara
       16 | ROM  | Romania                | Romani
       16 | SGP  | Singapore              | Tamil
       16 | CHE  | Switzerland            | Italian
       16 | ZWE  | Zimbabwe               | English
       16 | LUX  | Luxembourg             | French
       16 | CHE  | Switzerland            | Romansh
       16 | BEL  | Belgium                | German
       16 | ZAF  | South Africa           | English
       16 | LUX  | Luxembourg             | German
       16 | PAK  | Pakistan               | Urdu
(164 rows)

--query 6 Use CTE in the main query and subqueries within the main query
with bad_headofstates as 
(
 select country.code,country.name,country.headofstate,countrylanguage.language
 from
 country,countrylanguage
 where country.code = countrylanguage.countrycode and countrylanguage.isofficial=true
 and (country.gnp < country.gnpold or country.gnp < 3000)
)
select OUTERMOST_FOO.*,bad_headofstates.headofstate from (
select avg(population),region from
(
select FOO.*,bad_headofstates.headofstate,city.name
from
(select bad_headofstates.code,country.capital,country.region,country.population from
bad_headofstates,country where bad_headofstates.code = country.code) FOO, bad_headofstates,city
where FOO.code = bad_headofstates.code and FOO.capital = city.id) OUTER_FOO
group by region ) OUTERMOST_FOO,bad_headofstates,country 
where country.code = bad_headofstates.code and country.region = OUTERMOST_FOO.region
order by OUTERMOST_FOO.region,bad_headofstates.headofstate LIMIT 40;
       avg        |          region           |           headofstate            
------------------+---------------------------+----------------------------------
          4550620 | Australia and New Zealand | Elisabeth II
          4550620 | Australia and New Zealand | Elisabeth II
          4550620 | Australia and New Zealand | Elisabeth II
          4550620 | Australia and New Zealand | Elisabeth II
          4550620 | Australia and New Zealand | Elisabeth II
 744388.888888889 | Caribbean                 | Beatrix
 744388.888888889 | Caribbean                 | Beatrix
 744388.888888889 | Caribbean                 | Beatrix
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Elisabeth II
 744388.888888889 | Caribbean                 | Fidel Castro Ruz
 744388.888888889 | Caribbean                 | George W. Bush
 744388.888888889 | Caribbean                 | Jacques Chirac
          7651000 | Central Africa            | Idriss Deby
          2657500 | Central America           | Arnoldo Aleman Lacayo
          2657500 | Central America           | Elisabeth II
 5982809.52380952 | Eastern Africa            | Abdiqassim Salad Hassan
 5982809.52380952 | Eastern Africa            | Abdiqassim Salad Hassan
 5982809.52380952 | Eastern Africa            | Bakili Muluzi
 5982809.52380952 | Eastern Africa            | France-Albert Rene
 5982809.52380952 | Eastern Africa            | France-Albert Rene
 5982809.52380952 | Eastern Africa            | Isayas Afewerki [Isaias Afwerki]
 5982809.52380952 | Eastern Africa            | Ismail Omar Guelleh
 5982809.52380952 | Eastern Africa            | Jacques Chirac
 5982809.52380952 | Eastern Africa            | Paul Kagame
 5982809.52380952 | Eastern Africa            | Paul Kagame
 5982809.52380952 | Eastern Africa            | Pierre Buyoya
 5982809.52380952 | Eastern Africa            | Pierre Buyoya
 5982809.52380952 | Eastern Africa            | Robert G. Mugabe
         34288500 | Eastern Asia              | Akihito
         34288500 | Eastern Asia              | Chen Shui-bian
         34288500 | Eastern Asia              | Jiang Zemin
(40 rows)

-- query 7 Use CTE in the main query, where clause and having clause
with district_population as 
(select sum(city.population) DISTRICT_POP,count(*) NUM_CITIES,district,countrycode,country.name COUNTRY
 from city,country
 where city.countrycode = country.code
 group by district,countrycode,country.name
 HAVING (sum(city.population)/count(*)) > ( select avg(population) from city where countrycode = 'CHN'))
select sum(FOO.DISTRICT_POP),sum(FOO.NUM_CITIES),COUNTRY,CAPITAL,CAPITAL_POP
from
(
(select district_population.*,city.name CAPITAL,city.population CAPITAL_POP from
district_population,country,city
where district_population.countrycode = country.code AND city.id = country.capital
AND DISTRICT_POP >= ( select avg(DISTRICT_POP) FROM district_population where district IN (select district from city where countrycode = 'USA') )
order by COUNTRY,district)
UNION ALL
(select district_population.*,city.name CAPITAL,city.population CAPITAL_POP from
district_population,country,city
where district_population.countrycode = country.code AND city.id = country.capital
AND DISTRICT_POP >= ( select avg(DISTRICT_POP) FROM district_population where district IN (select district from city where countrycode = 'IND') )
order by COUNTRY,district)
UNION ALL
(select district_population.*,city.name CAPITAL,city.population CAPITAL_POP from
district_population,country,city
where district_population.countrycode = country.code AND city.id = country.capital
AND DISTRICT_POP >= ( select avg(DISTRICT_POP) FROM district_population where district IN (select district from city where countrycode = 'CHN') )
order by COUNTRY,district)
) FOO
WHERE FOO.CAPITAL_POP > (select min(DISTRICT_POP) from district_population)
group by FOO.COUNTRY,FOO.CAPITAL,FOO.CAPITAL_POP
HAVING sum(FOO.DISTRICT_POP) >= ( select avg(DISTRICT_POP) FROM district_population where district IN (select district from city where countrycode = 'AUS') )
AND (sum(FOO.DISTRICT_POP)/sum(FOO.NUM_CITIES)) <= 
( select avg(DISTRICT_POP) FROM district_population where district IN (select district from city where countrycode = 'USA' or countrycode = 'IND' or countrycode = 'CHN'))
order by FOO.country;
    sum    | sum |                country                |      capital      | capital_pop 
-----------+-----+---------------------------------------+-------------------+-------------
   4577018 |   8 | Bangladesh                            | Dhaka             |     3612850
  35875413 |  66 | Brazil                                | Brasilia          |     1969868
   5423156 |   4 | Chile                                 | Santiago de Chile |     4703954
 146743375 | 155 | China                                 | Peking            |     7472000
   6260862 |   1 | Colombia                              | Santafe de Bogota |     6260862
   5064000 |   1 | Congo, The Democratic Republic of the | Kinshasa          |     5064000
  10117675 |   2 | Egypt                                 | Cairo             |     6789479
   3386667 |   1 | Germany                               | Berlin            |     3386667
  25060392 |  18 | Iran                                  | Teheran           |     6758845
   4336000 |   1 | Iraq                                  | Baghdad           |     4336000
  48546381 |  84 | Japan                                 | Tokyo             |     7980230
  29789325 |  11 | Mexico                                | Ciudad de Mexico  |     8591309
   3095329 |   2 | Morocco                               | Rabat             |      623457
   3361700 |   1 | Myanmar                               | Rangoon (Yangon)  |     3361700
  33060243 |  12 | Pakistan                              | Islamabad         |      524500
  29545923 |  48 | Philippines                           | Manila            |     1581082
  30717000 |   9 | Russian Federation                    | Moscow            |     8389200
   6846000 |   5 | Saudi Arabia                          | Riyadh            |     3324000
   4017733 |   1 | Singapore                             | Singapore         |     4017733
   3962883 |   8 | Spain                                 | Madrid            |     2879052
   6320174 |   1 | Thailand                              | Bangkok           |     6320174
  26997078 |   6 | Turkey                                | Ankara            |     3038159
  26874255 |  18 | United States                         | Washington        |      572059
   3980000 |   1 | Vietnam                               | Hanoi             |     1410000
(24 rows)

-- query8 Use CTE in the select list and the from clause - MPP-13943
with official_languages as
(
 select country.code,country.name,countrylanguage.language
 from
 country,countrylanguage
 where country.code = countrylanguage.countrycode and isofficial = 'True'
)
select
( select max(CNT) from (select count(*) CNT from official_languages) FOO	
)
,* from official_languages order by official_languages.code,official_languages.language;
 ?column? | code |                 name                 |     language     
----------+------+--------------------------------------+------------------
      238 | ABW  | Aruba                                | Dutch
      238 | AFG  | Afghanistan                          | Dari
      238 | AFG  | Afghanistan                          | Pashto
      238 | AIA  | Anguilla                             | English
      238 | ALB  | Albania                              | Albaniana
      238 | AND  | Andorra                              | Catalan
      238 | ANT  | Netherlands Antilles                 | Dutch
      238 | ANT  | Netherlands Antilles                 | Papiamento
      238 | ARE  | United Arab Emirates                 | Arabic
      238 | ARG  | Argentina                            | Spanish
      238 | ARM  | Armenia                              | Armenian
      238 | ASM  | American Samoa                       | English
      238 | ASM  | American Samoa                       | Samoan
      238 | ATG  | Antigua and Barbuda                  | English
      238 | AUS  | Australia                            | English
      238 | AUT  | Austria                              | German
      238 | AZE  | Azerbaijan                           | Azerbaijani
      238 | BDI  | Burundi                              | French
      238 | BDI  | Burundi                              | Kirundi
      238 | BEL  | Belgium                              | Dutch
      238 | BEL  | Belgium                              | French
      238 | BEL  | Belgium                              | German
      238 | BGD  | Bangladesh                           | Bengali
      238 | BGR  | Bulgaria                             | Bulgariana
      238 | BHR  | Bahrain                              | Arabic
      238 | BIH  | Bosnia and Herzegovina               | Serbo-Croatian
      238 | BLR  | Belarus                              | Belorussian
      238 | BLR  | Belarus                              | Russian
      238 | BLZ  | Belize                               | English
      238 | BMU  | Bermuda                              | English
      238 | BOL  | Bolivia                              | Aimara
      238 | BOL  | Bolivia                              | Ketdua
      238 | BOL  | Bolivia                              | Spanish
      238 | BRA  | Brazil                               | Portuguese
      238 | BRB  | Barbados                             | English
      238 | BRN  | Brunei                               | Malay
      238 | BTN  | Bhutan                               | Dzongkha
      238 | CAN  | Canada                               | English
      238 | CAN  | Canada                               | French
      238 | CCK  | Cocos (Keeling) Islands              | English
      238 | CHE  | Switzerland                          | French
      238 | CHE  | Switzerland                          | German
      238 | CHE  | Switzerland                          | Italian
      238 | CHE  | Switzerland                          | Romansh
      238 | CHL  | Chile                                | Spanish
      238 | CHN  | China                                | Chinese
      238 | COK  | Cook Islands                         | Maori
      238 | COL  | Colombia                             | Spanish
      238 | COM  | Comoros                              | Comorian
      238 | CPV  | Cape Verde                           | Portuguese
      238 | CRI  | Costa Rica                           | Spanish
      238 | CUB  | Cuba                                 | Spanish
      238 | CXR  | Christmas Island                     | English
      238 | CYM  | Cayman Islands                       | English
      238 | CYP  | Cyprus                               | Greek
      238 | CYP  | Cyprus                               | Turkish
      238 | CZE  | Czech Republic                       | Czech
      238 | DEU  | Germany                              | German
      238 | DJI  | Djibouti                             | Arabic
      238 | DNK  | Denmark                              | Danish
      238 | DOM  | Dominican Republic                   | Spanish
      238 | DZA  | Algeria                              | Arabic
      238 | ECU  | Ecuador                              | Spanish
      238 | EGY  | Egypt                                | Arabic
      238 | ERI  | Eritrea                              | Tigrinja
      238 | ESH  | Western Sahara                       | Arabic
      238 | ESP  | Spain                                | Spanish
      238 | EST  | Estonia                              | Estonian
      238 | FIN  | Finland                              | Finnish
      238 | FIN  | Finland                              | Swedish
      238 | FJI  | Fiji Islands                         | Fijian
      238 | FLK  | Falkland Islands                     | English
      238 | FRA  | France                               | French
      238 | FRO  | Faroe Islands                        | Danish
      238 | FRO  | Faroe Islands                        | Faroese
      238 | GBR  | United Kingdom                       | English
      238 | GEO  | Georgia                              | Georgiana
      238 | GIB  | Gibraltar                            | English
      238 | GLP  | Guadeloupe                           | French
      238 | GNB  | Guinea-Bissau                        | Portuguese
      238 | GRC  | Greece                               | Greek
      238 | GRL  | Greenland                            | Danish
      238 | GRL  | Greenland                            | Greenlandic
      238 | GTM  | Guatemala                            | Spanish
      238 | GUM  | Guam                                 | Chamorro
      238 | GUM  | Guam                                 | English
      238 | HKG  | Hong Kong                            | English
      238 | HND  | Honduras                             | Spanish
      238 | HRV  | Croatia                              | Serbo-Croatian
      238 | HTI  | Haiti                                | French
      238 | HUN  | Hungary                              | Hungarian
      238 | IDN  | Indonesia                            | Malay
      238 | IND  | India                                | Hindi
      238 | IRL  | Ireland                              | English
      238 | IRL  | Ireland                              | Irish
      238 | IRN  | Iran                                 | Persian
      238 | IRQ  | Iraq                                 | Arabic
      238 | ISL  | Iceland                              | Icelandic
      238 | ISR  | Israel                               | Arabic
      238 | ISR  | Israel                               | Hebrew
      238 | ITA  | Italy                                | Italian
      238 | JOR  | Jordan                               | Arabic
      238 | JPN  | Japan                                | Japanese
      238 | KAZ  | Kazakstan                            | Kazakh
      238 | KGZ  | Kyrgyzstan                           | Kirgiz
      238 | KGZ  | Kyrgyzstan                           | Russian
      238 | KHM  | Cambodia                             | Khmer
      238 | KIR  | Kiribati                             | Kiribati
      238 | KNA  | Saint Kitts and Nevis                | English
      238 | KOR  | South Korea                          | Korean
      238 | KWT  | Kuwait                               | Arabic
      238 | LAO  | Laos                                 | Lao
      238 | LBN  | Lebanon                              | Arabic
      238 | LBY  | Libyan Arab Jamahiriya               | Arabic
      238 | LCA  | Saint Lucia                          | English
      238 | LIE  | Liechtenstein                        | German
      238 | LKA  | Sri Lanka                            | Singali
      238 | LKA  | Sri Lanka                            | Tamil
      238 | LSO  | Lesotho                              | English
      238 | LSO  | Lesotho                              | Sotho
      238 | LTU  | Lithuania                            | Lithuanian
      238 | LUX  | Luxembourg                           | French
      238 | LUX  | Luxembourg                           | German
      238 | LUX  | Luxembourg                           | Luxembourgish
      238 | LVA  | Latvia                               | Latvian
      238 | MAC  | Macao                                | Portuguese
      238 | MAR  | Morocco                              | Arabic
      238 | MCO  | Monaco                               | French
      238 | MDA  | Moldova                              | Romanian
      238 | MDG  | Madagascar                           | French
      238 | MDG  | Madagascar                           | Malagasy
      238 | MDV  | Maldives                             | Dhivehi
      238 | MEX  | Mexico                               | Spanish
      238 | MHL  | Marshall Islands                     | English
      238 | MHL  | Marshall Islands                     | Marshallese
      238 | MKD  | Macedonia                            | Macedonian
      238 | MLT  | Malta                                | English
      238 | MLT  | Malta                                | Maltese
      238 | MMR  | Myanmar                              | Burmese
      238 | MNG  | Mongolia                             | Mongolian
      238 | MNP  | Northern Mariana Islands             | English
      238 | MSR  | Montserrat                           | English
      238 | MTQ  | Martinique                           | French
      238 | MWI  | Malawi                               | Chichewa
      238 | MYS  | Malaysia                             | Malay
      238 | MYT  | Mayotte                              | French
      238 | NCL  | New Caledonia                        | French
      238 | NFK  | Norfolk Island                       | English
      238 | NIC  | Nicaragua                            | Spanish
      238 | NIU  | Niue                                 | English
      238 | NLD  | Netherlands                          | Dutch
      238 | NOR  | Norway                               | Norwegian
      238 | NPL  | Nepal                                | Nepali
      238 | NRU  | Nauru                                | English
      238 | NRU  | Nauru                                | Nauru
      238 | NZL  | New Zealand                          | English
      238 | OMN  | Oman                                 | Arabic
      238 | PAK  | Pakistan                             | Urdu
      238 | PAN  | Panama                               | Spanish
      238 | PER  | Peru                                 | Aimara
      238 | PER  | Peru                                 | Ketdua
      238 | PER  | Peru                                 | Spanish
      238 | PHL  | Philippines                          | Pilipino
      238 | PLW  | Palau                                | English
      238 | PLW  | Palau                                | Palau
      238 | POL  | Poland                               | Polish
      238 | PRI  | Puerto Rico                          | Spanish
      238 | PRK  | North Korea                          | Korean
      238 | PRT  | Portugal                             | Portuguese
      238 | PRY  | Paraguay                             | Guarani
      238 | PRY  | Paraguay                             | Spanish
      238 | PYF  | French Polynesia                     | French
      238 | QAT  | Qatar                                | Arabic
      238 | ROM  | Romania                              | Romani
      238 | ROM  | Romania                              | Romanian
      238 | RUS  | Russian Federation                   | Russian
      238 | RWA  | Rwanda                               | French
      238 | RWA  | Rwanda                               | Rwanda
      238 | SAU  | Saudi Arabia                         | Arabic
      238 | SDN  | Sudan                                | Arabic
      238 | SEN  | Senegal                              | Wolof
      238 | SGP  | Singapore                            | Chinese
      238 | SGP  | Singapore                            | Malay
      238 | SGP  | Singapore                            | Tamil
      238 | SHN  | Saint Helena                         | English
      238 | SJM  | Svalbard and Jan Mayen               | Norwegian
      238 | SLV  | El Salvador                          | Spanish
      238 | SMR  | San Marino                           | Italian
      238 | SOM  | Somalia                              | Arabic
      238 | SOM  | Somalia                              | Somali
      238 | SPM  | Saint Pierre and Miquelon            | French
      238 | SVK  | Slovakia                             | Slovak
      238 | SVN  | Slovenia                             | Slovene
      238 | SWE  | Sweden                               | Swedish
      238 | SWZ  | Swaziland                            | Swazi
      238 | SYC  | Seychelles                           | English
      238 | SYC  | Seychelles                           | French
      238 | SYR  | Syria                                | Arabic
      238 | TCA  | Turks and Caicos Islands             | English
      238 | TCD  | Chad                                 | Arabic
      238 | TGO  | Togo                                 | Ewe
      238 | TGO  | Togo                                 | Kabye
      238 | THA  | Thailand                             | Thai
      238 | TJK  | Tajikistan                           | Tadzhik
      238 | TKL  | Tokelau                              | English
      238 | TKM  | Turkmenistan                         | Turkmenian
      238 | TMP  | East Timor                           | Portuguese
      238 | TON  | Tonga                                | English
      238 | TON  | Tonga                                | Tongan
      238 | TUN  | Tunisia                              | Arabic
      238 | TUR  | Turkey                               | Turkish
      238 | TUV  | Tuvalu                               | English
      238 | TUV  | Tuvalu                               | Tuvalu
      238 | TWN  | Taiwan                               | Mandarin Chinese
      238 | TZA  | Tanzania                             | Swahili
      238 | UKR  | Ukraine                              | Ukrainian
      238 | UMI  | United States Minor Outlying Islands | English
      238 | URY  | Uruguay                              | Spanish
      238 | USA  | United States                        | English
      238 | UZB  | Uzbekistan                           | Uzbek
      238 | VAT  | Holy See (Vatican City State)        | Italian
      238 | VCT  | Saint Vincent and the Grenadines     | English
      238 | VEN  | Venezuela                            | Spanish
      238 | VGB  | Virgin Islands, British              | English
      238 | VIR  | Virgin Islands, U.S.                 | English
      238 | VNM  | Vietnam                              | Vietnamese
      238 | VUT  | Vanuatu                              | Bislama
      238 | VUT  | Vanuatu                              | English
      238 | VUT  | Vanuatu                              | French
      238 | WSM  | Samoa                                | English
      238 | WSM  | Samoa                                | Samoan
      238 | YEM  | Yemen                                | Arabic
      238 | YUG  | Yugoslavia                           | Serbo-Croatian
      238 | ZAF  | South Africa                         | Afrikaans
      238 | ZAF  | South Africa                         | English
      238 | ZAF  | South Africa                         | Xhosa
      238 | ZAF  | South Africa                         | Zulu
      238 | ZWE  | Zimbabwe                             | English
(238 rows)

