-- start_ignore
-- end_ignore
-- @author ramans2
-- @created 2014-03-27 12:00:00
-- @modified 2014-03-27 12:00:00
-- @gpdiff True
-- @description Large query that fails with OOM
--start_ignore
drop table if exists mst;
DROP TABLE
drop table if exists dim_01;
DROP TABLE
drop table if exists dim_02;
DROP TABLE
drop table if exists dim_03;
DROP TABLE
drop table if exists dim_04;
DROP TABLE
drop table if exists dim_05;
DROP TABLE
drop table if exists dim_06;
DROP TABLE
drop table if exists dim_07;
DROP TABLE
drop table if exists dim_08;
DROP TABLE
drop table if exists dim_09;
DROP TABLE
drop table if exists dim_10;
DROP TABLE
drop table if exists dim_11;
DROP TABLE
drop table if exists dim_12;
DROP TABLE
drop table if exists dim_13;
DROP TABLE
drop table if exists dim_14;
DROP TABLE
drop table if exists dim_15;
DROP TABLE
drop table if exists dim_16;
DROP TABLE
drop table if exists dim_17;
DROP TABLE
drop table if exists dim_18;
DROP TABLE
drop table if exists dim_19;
DROP TABLE
drop table if exists dim_20;
DROP TABLE
drop table if exists dim_21;
DROP TABLE
drop table if exists dim_22;
DROP TABLE
drop table if exists dim_23;
DROP TABLE
drop table if exists dim_24;
DROP TABLE
drop table if exists dim_25;
DROP TABLE
--end_ignore
--Fact Table
create table mst
(
seq int,
dim_01_cd int,
dim_02_cd int,
dim_03_cd int,
dim_04_cd int,
dim_05_cd int,
dim_06_cd int,
dim_07_cd int,
dim_08_cd int,
dim_09_cd int,
dim_10_cd int,
dim_11_cd int,
dim_12_cd int,
dim_13_cd int,
dim_14_cd int,
dim_15_cd int,
dim_16_cd int,
dim_17_cd int,
dim_18_cd int,
dim_19_cd int,
dim_20_cd int,
dim_21_cd int,
dim_22_cd int,
dim_23_cd int,
dim_24_cd int,
dim_25_cd int,
qry int,
amt int
)
distributed by (seq);
CREATE TABLE
--Dimension Table
create table dim_01 ( dim_01_cd int, dim_01_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:75: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_01_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_02 ( dim_02_cd int, dim_02_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:76: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_02_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_03 ( dim_03_cd int, dim_03_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:77: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_03_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_04 ( dim_04_cd int, dim_04_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:78: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_04_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_05 ( dim_05_cd int, dim_05_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:79: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_05_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_06 ( dim_06_cd int, dim_06_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:80: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_06_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_07 ( dim_07_cd int, dim_07_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:81: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_07_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_08 ( dim_08_cd int, dim_08_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:82: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_08_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_09 ( dim_09_cd int, dim_09_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:83: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_09_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_10 ( dim_10_cd int, dim_10_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:84: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_10_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_11 ( dim_11_cd int, dim_11_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:85: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_11_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_12 ( dim_12_cd int, dim_12_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:86: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_12_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_13 ( dim_13_cd int, dim_13_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:87: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_13_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_14 ( dim_14_cd int, dim_14_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:88: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_14_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_15 ( dim_15_cd int, dim_15_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:89: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_15_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_16 ( dim_16_cd int, dim_16_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:90: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_16_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_17 ( dim_17_cd int, dim_17_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:91: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_17_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_18 ( dim_18_cd int, dim_18_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:92: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_18_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_19 ( dim_19_cd int, dim_19_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:93: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_19_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_20 ( dim_20_cd int, dim_20_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:94: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_20_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_21 ( dim_21_cd int, dim_21_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:95: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_21_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_22 ( dim_22_cd int, dim_22_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:96: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_22_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_23 ( dim_23_cd int, dim_23_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:97: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_23_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_24 ( dim_24_cd int, dim_24_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:98: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_24_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
create table dim_25 ( dim_25_cd int, dim_25_cd_nm varchar(10)) ;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:99: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'dim_25_cd' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE
--Insert into Fact Table
INSERT INTO mst(
seq, dim_01_cd, dim_02_cd, dim_03_cd, dim_04_cd, dim_05_cd, dim_06_cd,
dim_07_cd, dim_08_cd, dim_09_cd, dim_10_cd, dim_11_cd, dim_12_cd, dim_13_cd,
dim_14_cd, dim_15_cd, dim_16_cd, dim_17_cd, dim_18_cd, dim_19_cd, dim_20_cd,
dim_21_cd, dim_22_cd, dim_23_cd, dim_24_cd, dim_25_cd,
qry, amt)
select i, i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100,
i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100, i%100,
i%100, i%100, i%100, i%100, i%100,10, 100
from generate_series(1, 100000) i;
INSERT 0 100000
-- Insert into Dimesion Table
insert into dim_01 values (generate_series(1, 100), 'asdfasdf');
INSERT 0 100
insert into dim_02 select * From dim_01;
INSERT 0 100
insert into dim_03 select * From dim_01;
INSERT 0 100
insert into dim_04 select * From dim_01;
INSERT 0 100
insert into dim_05 select * From dim_01;
INSERT 0 100
insert into dim_06 select * From dim_01;
INSERT 0 100
insert into dim_07 select * From dim_01;
INSERT 0 100
insert into dim_08 select * From dim_01;
INSERT 0 100
insert into dim_09 select * From dim_01;
INSERT 0 100
insert into dim_10 select * From dim_01;
INSERT 0 100
insert into dim_11 select * From dim_01;
INSERT 0 100
insert into dim_12 select * From dim_01;
INSERT 0 100
insert into dim_13 select * From dim_01;
INSERT 0 100
insert into dim_14 select * From dim_01;
INSERT 0 100
insert into dim_15 select * From dim_01;
INSERT 0 100
insert into dim_16 select * From dim_01;
INSERT 0 100
insert into dim_17 select * From dim_01;
INSERT 0 100
insert into dim_18 select * From dim_01;
INSERT 0 100
insert into dim_19 select * From dim_01;
INSERT 0 100
insert into dim_20 select * From dim_01;
INSERT 0 100
insert into dim_21 select * From dim_01;
INSERT 0 100
insert into dim_22 select * From dim_01;
INSERT 0 100
insert into dim_23 select * From dim_01;
INSERT 0 100
insert into dim_24 select * From dim_01;
INSERT 0 100
insert into dim_25 select * From dim_01;
INSERT 0 100
show gp_vmem_protect_limit;
 gp_vmem_protect_limit 
-----------------------
 40
(1 row)

select 5 as oom_test;
 oom_test 
----------
        5
(1 row)

select
dim_01_cd_nm,
dim_02_cd_nm,
dim_03_cd_nm,
dim_04_cd_nm,
dim_05_cd_nm,
dim_06_cd_nm,
dim_07_cd_nm,
dim_08_cd_nm,
dim_09_cd_nm,
dim_10_cd_nm,
dim_11_cd_nm,
dim_12_cd_nm,
dim_13_cd_nm,
dim_14_cd_nm,
dim_15_cd_nm,
sum(qry),
sum(amt)
from mst a00,
dim_01 a01,
dim_02 a02,
dim_03 a03,
dim_04 a04,
dim_05 a05,
dim_06 a06,
dim_07 a07,
dim_08 a08,
dim_09 a09,
dim_10 a10,
dim_11 a11,
dim_12 a12,
dim_13 a13,
dim_14 a14,
dim_15 a15,
(select pg_sleep(100)) as t
where a00.dim_01_cd = a01.dim_01_cd
and a00.dim_02_cd = a02.dim_02_cd
and a00.dim_03_cd = a03.dim_03_cd
and a00.dim_04_cd = a04.dim_04_cd
and a00.dim_05_cd = a05.dim_05_cd
and a00.dim_06_cd = a06.dim_06_cd
and a00.dim_07_cd = a07.dim_07_cd
and a00.dim_08_cd = a08.dim_08_cd
and a00.dim_09_cd = a09.dim_09_cd
and a00.dim_10_cd = a10.dim_10_cd
and a00.dim_11_cd = a11.dim_11_cd
and a00.dim_12_cd = a12.dim_12_cd
and a00.dim_13_cd = a13.dim_13_cd
and a00.dim_14_cd = a14.dim_14_cd
and a00.dim_15_cd = a15.dim_15_cd
group by
dim_01_cd_nm,
dim_02_cd_nm,
dim_03_cd_nm,
dim_04_cd_nm,
dim_05_cd_nm,
dim_06_cd_nm,
dim_07_cd_nm,
dim_08_cd_nm,
dim_09_cd_nm,
dim_10_cd_nm,
dim_11_cd_nm,
dim_12_cd_nm,
dim_13_cd_nm,
dim_14_cd_nm,
dim_15_cd_nm
;
psql:/data/home/gpadmin/suchitra/tincrepo/main/resource_management/memory_accounting/scenario/oom_test/output/oom_massive.sql:209: ERROR:  Out of memory  (seg0 slice17 mdw:40000 pid=29477)
DETAIL:  VM Protect failed to allocate 65536 bytes, 0 MB available
