DROP DATABASE IF EXISTS testanalyze;
CREATE DATABASE testanalyze;
\c testanalyze
set client_min_messages='WARNING';
-- Case 1: Analyzing root table with GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition set off should only populate stats for leaf tables
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        1
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(5 rows)

-- Case 2: Analyzing a midlevel partition directly should give a WARNING message and should not update any stats for the table.
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales_1_prt_2;
WARNING:  skipping "p3_sales_1_prt_2" --- cannot analyze a mid-level partition. Please run ANALYZE on the root partition table.
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        0
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
(0 rows)

-- Case 3: Analyzing leaf table directly should update the stats only for itself
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales_1_prt_2_2_prt_2_3_prt_usa;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        0
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(5 rows)

-- Case 4: Analyzing the database with the GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition set to OFF should update stats for all table except root tables
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        1
 p3_sales_1_prt_2                                                |         2 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         2 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales_1_prt_2                   | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(15 rows)

-- Case 5: Vacuum analyzing the database should vacuum all the tables for p3_sales and should update the stats for all partitions for p3_sales except root partition
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
vacuum analyze;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        1
 p3_sales_1_prt_2                                                |         0 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales_1_prt_2                   | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(15 rows)

select count(*) from pg_stat_last_operation pgl, pg_class pgc where pgl.objid=pgc.oid and pgc.relname like 'p3_sales%';
 count 
-------
    59
(1 row)

-- Case 6: Analyzing root table with ROOTPARTITION keyword should only update the stats of the root table when the GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition are set off
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales  | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales  | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales  | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(5 rows)

-- Case 7: Analyzing a midlevel partition should give a warning if using ROOTPARTITION keyword and should not update any stats.
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales_1_prt_2;
WARNING:  skipping "p3_sales_1_prt_2" --- cannot analyze a non-root partition using ANALYZE ROOTPARTITION
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        0
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
(0 rows)

-- Case 8: Analyzing a leaf partition should give a warning if using ROOTPARTITION keyword and should not update any stats.
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales_1_prt_2_2_prt_2_3_prt_usa;
WARNING:  skipping "p3_sales_1_prt_2_2_prt_2_3_prt_usa" --- cannot analyze a non-root partition using ANALYZE ROOTPARTITION
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        0
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
(0 rows)

-- Case 9: Analyzing root table with GUC optimizer_analyze_root_partition set to ON and GUC optimizer_analyze_midlevel_partition set to off should update the leaf table and the root table stats.
set optimizer_analyze_root_partition=on;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales                           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales                           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales                           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(10 rows)

-- Case 10: Analyzing root table using ROOTPARTITION keyword with GUC optimizer_analyze_root_partition set to ON and GUC optimizer_analyze_midlevel_partition set to off should update the root table stats only.
set optimizer_analyze_root_partition=on;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales  | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales  | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales  | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(5 rows)

-- Case 11: Analyzing root table with GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition set to ON should update the stats for root, midlevel and leaf partitions.
set optimizer_analyze_root_partition=on;
set optimizer_analyze_midlevel_partition=on;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         2 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         2 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales                           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales                           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales                           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(20 rows)

-- Case 12: Analyzing root table using ROOTPARTITION keyword with GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition set to ON should update the stats for root and midlevel partitions only.
set optimizer_analyze_root_partition=on;
set optimizer_analyze_midlevel_partition=on;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         2 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         2 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |        tablename         | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+--------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales                 | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales                 | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                 | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                 | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales                 | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(15 rows)

-- Case 13: Analyzing root table using ROOTPARTITION keyword with GUC optimizer_analyze_root_partition and optimizer_analyze_midlevel_partition set to OFF should update the stats for root partition only.
set optimizer_analyze_root_partition=on;
set optimizer_analyze_midlevel_partition=off;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         0 |        0
 p3_sales_1_prt_2_2_prt_2                                        |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname | tablename | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+-----------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales  | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales  | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales  | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales  | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(5 rows)

-- Case 14: Analyzing root table with GUC optimizer_analyze_root_partition set to OFF and optimizer_analyze_midlevel_partition set to On should update the stats for midlevel and leaf partition only.
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=on;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         0 |        1
 p3_sales_1_prt_2                                                |         2 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         2 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         2 |        1
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        1
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        1
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |             tablename              | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+------------------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales_1_prt_2                   | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2                   | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2           | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2_3_prt_usa | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(15 rows)

-- Case 15: Analyzing root table using ROOTPARTITION keyword with GUC optimizer_analyze_root_partition set to OFF and optimizer_analyze_midlevel_partition set to On should update the stats for root, midlevel and leaf partition only.
set optimizer_analyze_root_partition=off;
set optimizer_analyze_midlevel_partition=on;
DROP TABLE if exists p3_sales;
CREATE TABLE p3_sales (id int, year int, month int, day int,
region text)
DISTRIBUTED BY (id)
PARTITION BY RANGE (year)
    SUBPARTITION BY RANGE (month)
       SUBPARTITION TEMPLATE (
        START (1) END (2) EVERY (1),
        DEFAULT SUBPARTITION other_months )
           SUBPARTITION BY LIST (region)
             SUBPARTITION TEMPLATE (
               SUBPARTITION usa VALUES ('usa'),
               DEFAULT SUBPARTITION other_regions )
( START (2002) END (2003) EVERY (1),
  DEFAULT PARTITION outlying_years );
insert into p3_sales values (1, 2002, 1, 20, 'usa');
insert into p3_sales values (1, 2002, 1, 20, 'usa');
analyze rootpartition p3_sales;
select relname, reltuples, relpages from pg_class where relname like 'p3_sales%' order by relname;
                             relname                             | reltuples | relpages 
-----------------------------------------------------------------+-----------+----------
 p3_sales                                                        |         2 |        1
 p3_sales_1_prt_2                                                |         2 |        1
 p3_sales_1_prt_2_2_prt_2                                        |         2 |        1
 p3_sales_1_prt_2_2_prt_2_3_prt_other_regions                    |         0 |        0
 p3_sales_1_prt_2_2_prt_2_3_prt_usa                              |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months                             |         0 |        1
 p3_sales_1_prt_2_2_prt_other_months_3_prt_other_regions         |         0 |        0
 p3_sales_1_prt_2_2_prt_other_months_3_prt_usa                   |         0 |        0
 p3_sales_1_prt_outlying_years                                   |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2                           |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_other_regions       |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_2_3_prt_usa                 |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_m_3_prt_other_regions |         0 |        0
 p3_sales_1_prt_outlying_years_2_prt_other_months                |         0 |        1
 p3_sales_1_prt_outlying_years_2_prt_other_months_3_prt_usa      |         0 |        0
(15 rows)

select * from pg_stats where tablename like 'p3_sales%' order by tablename, attname;
 schemaname |        tablename         | attname | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogram_bounds | correlation 
------------+--------------------------+---------+-----------+-----------+------------+------------------+-------------------+------------------+-------------
 public     | p3_sales                 | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales                 | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                 | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales                 | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales                 | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2         | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | day     |         0 |         4 |       -0.5 | {20}             | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | id      |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | month   |         0 |         4 |       -0.5 | {1}              | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | region  |         0 |         4 |       -0.5 | {usa}            | {1}               |                  |           1
 public     | p3_sales_1_prt_2_2_prt_2 | year    |         0 |         4 |       -0.5 | {2002}           | {1}               |                  |           1
(15 rows)

-- start_ignore
DROP TABLE IF EXISTS p3_sales;
-- end_ignore
